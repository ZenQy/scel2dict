name: Update Dictionary
on:
  schedule:
    - cron: 0 20 1 * *
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false
env:
  TZ: Asia/Shanghai

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

      - name: Delete older workflow runs and artifacts
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 3
          keep_minimum_runs: 3

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Initialization Environment
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /usr/local/lib/android /opt/ghc
          sudo -E apt -y update
          sudo -E apt -y install golang libime-bin curl
          sudo -E apt -y autoremove --purge
          sudo -E apt -y clean
          echo "DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

      - name: Setup tmate session
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3

      - name: Downloads scels
        run : |
          mkdir scel
          for link in $(cat list.txt); do
            name=$(echo $link | awk -F '&|=' '{print $4}')
            curl $link -o scel/${name}.scel
          done

      - name: Transform scels files
        run: |
          go run main.go

      - name: Transform txt files
        run : |
          cd out
          sort -u all.txt > zenith.txt
          sed -i 's/lue/lve/g'  zenith.txt
          sed -i 's/nue/nve/g'  zenith.txt
          libime_pinyindict zenith.txt zenith.dict

      - name: Upload Dictionary To Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          removeArtifacts: true
          tag: v${{ env.DATE }}
          artifacts: out/zenith.*

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: success()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
